<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Candidlabs Reports & Analytics - Data insights and operational dashboards for Candid Mixers.">
  <title>Reports - Candidlabs</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body data-auth-require="true">
  <!-- Navigation -->
  <nav class="navbar" role="navigation" aria-label="Main navigation">
    <div class="container navbar-container">
      <a href="index.html" class="logo" aria-label="Candidlabs home">candidlabs</a>

      <ul class="nav-menu" role="menubar">
        <li role="none" class="nav-dropdown">
          <button class="nav-link nav-dropdown-trigger" type="button" aria-expanded="false" aria-haspopup="true">Sales ‚ñæ</button>
          <ul class="nav-dropdown-menu">
            <li><a href="crm/index.html" class="nav-dropdown-item">CRM</a></li>
            <li><a href="prospecting/index.html" class="nav-dropdown-item">Prospecting</a></li>
          </ul>
        </li>
        <li role="none" class="nav-dropdown" data-auth-role="partner">
          <button class="nav-link nav-dropdown-trigger" type="button" aria-expanded="false" aria-haspopup="true">Workspace ‚ñæ</button>
          <ul class="nav-dropdown-menu">
            <li><a href="projects/index.html" class="nav-dropdown-item">Projects</a></li>
            <li><a href="rnd/index.html" class="nav-dropdown-item">R&D</a></li>
          </ul>
        </li>
        <li role="none"><a href="reports.html" class="nav-link" role="menuitem">Reports</a></li>
        <li role="none" class="nav-dropdown">
              <button class="nav-link nav-dropdown-trigger" type="button" aria-expanded="false" aria-haspopup="true">Tools ‚ñæ</button>
              <ul class="nav-dropdown-menu">
                <li><a href="https://docs.google.com/forms/d/18dshhMSz7csbJBbeLg_fba6SAJMG5uyd3DnkW59rVSw/viewform" class="nav-dropdown-item" target="_blank" rel="noopener">KAA Form</a></li>
                <li><a href="https://docs.google.com/spreadsheets/d/19kDef25LdbvPssTkMusFGu8FmNbj2rWuF7NNF9SBSvs/edit" class="nav-dropdown-item" target="_blank" rel="noopener">Quote Generator</a></li>
                <li><a href="https://xero.me" class="nav-dropdown-item" target="_blank" rel="noopener">Submit Expenses</a></li>
              </ul>
            </li>
      </ul>

      <div class="nav-actions">
        <button
          id="theme-toggle"
          class="theme-toggle"
          type="button"
          aria-label="Switch to dark mode"
        >
          <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
          <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        </button>

        <a href="login.html" class="btn btn-primary btn-login" aria-label="Login">Login</a>

        <button
          id="mobile-menu-toggle"
          class="mobile-menu-toggle"
          type="button"
          aria-label="Toggle navigation menu"
          aria-expanded="false"
          aria-controls="mobile-menu"
        >
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
    </div>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="mobile-menu" role="menu" aria-label="Mobile navigation">
      <ul>
        <li class="mobile-menu-label">Sales</li>
        <li><a href="crm/index.html" role="menuitem">CRM</a></li>
        <li><a href="prospecting/index.html" role="menuitem">Prospecting</a></li>
        <li class="mobile-menu-label" data-auth-role="partner">Workspace</li>
        <li data-auth-role="partner"><a href="projects/index.html" role="menuitem">Projects</a></li>
        <li data-auth-role="partner"><a href="rnd/index.html" role="menuitem">R&D</a></li>
        <li><a href="reports.html" role="menuitem">Reports</a></li>
        <li><a href="https://docs.google.com/forms/d/18dshhMSz7csbJBbeLg_fba6SAJMG5uyd3DnkW59rVSw/viewform" role="menuitem" target="_blank" rel="noopener">KAA Form</a></li>
      <li><a href="https://docs.google.com/spreadsheets/d/19kDef25LdbvPssTkMusFGu8FmNbj2rWuF7NNF9SBSvs/edit" role="menuitem" target="_blank" rel="noopener">Quote Generator</a></li>
      <li><a href="https://xero.me" role="menuitem" target="_blank" rel="noopener">Submit Expenses</a></li>
        <li><a href="login.html" role="menuitem">Login</a></li>
      </ul>
    </div>
  </nav>

  <main>
    <!-- Page Header -->
    <header class="page-header">
      <div class="container">
        <h1 class="page-title">Reports & Analytics</h1>
        <p class="page-description">Data insights and operational dashboards</p>
      </div>
    </header>

    <!-- Reports Grid Section -->
    <section class="section" aria-labelledby="reports-grid-title">
      <div class="container">
        <h2 id="reports-grid-title" class="sr-only">Available Reports</h2>
        <div class="reports-grid">
          <!-- Management Overview -->
          <article class="card">
            <div class="report-preview" aria-hidden="true">
              <div class="text-center">
                <div class="report-preview-icon">üéØ</div>
                <span>Report Preview</span>
              </div>
            </div>
            <h3 class="card-title">Management Overview</h3>
            <p class="card-description">Executive dashboard with sales, production, financial, and operational KPIs.</p>
            <a href="dashboard.html" class="btn btn-secondary">View Report</a>
          </article>

          <!-- Sales Performance -->
          <article class="card">
            <div class="report-preview" aria-hidden="true">
              <div class="text-center">
                <div class="report-preview-icon">üìä</div>
                <span>Report Preview</span>
              </div>
            </div>
            <h3 class="card-title">Sales Performance</h3>
            <p class="card-description">Channel performance, revenue trends, and customer insights for sales teams.</p>
            <span class="btn btn-secondary btn-disabled">Coming Soon</span>
          </article>

          <!-- Production & Delivery -->
          <article class="card">
            <div class="report-preview" aria-hidden="true">
              <div class="text-center">
                <div class="report-preview-icon">üìà</div>
                <span>Report Preview</span>
              </div>
            </div>
            <h3 class="card-title">Production & Delivery</h3>
            <p class="card-description">Daily output, efficiency metrics, and batch tracking for manufacturing operations.</p>
            <span class="btn btn-secondary btn-disabled">Coming Soon</span>
          </article>

          <!-- Financial Overview (partner+) -->
          <article class="card" data-auth-role="partner">
            <div class="report-preview" aria-hidden="true">
              <div class="text-center">
                <div class="report-preview-icon">üíπ</div>
                <span>Report Preview</span>
              </div>
            </div>
            <h3 class="card-title">Financial Overview</h3>
            <p class="card-description">COGS analysis, gross margins, and P&L summaries for financial planning.</p>
            <span class="btn btn-secondary btn-disabled">Coming Soon</span>
          </article>

          <!-- SKD Performance (partner+) -->
          <article class="card" data-auth-role="partner">
            <div class="report-preview" aria-hidden="true">
              <div class="text-center">
                <div class="report-preview-icon">üè∑Ô∏è</div>
                <span>Report Preview</span>
              </div>
            </div>
            <h3 class="card-title">SKD Performance</h3>
            <p class="card-description">Product-level sales and margin analysis for portfolio optimization.</p>
            <span class="btn btn-secondary btn-disabled">Coming Soon</span>
          </article>

          <!-- Social Media -->
          <article class="card">
            <div class="report-preview" aria-hidden="true">
              <div class="text-center">
                <div class="report-preview-icon">üì±</div>
                <span>Report Preview</span>
              </div>
            </div>
            <h3 class="card-title">Social Media</h3>
            <p class="card-description">Social media engagement, reach, and campaign performance metrics.</p>
            <span class="btn btn-secondary btn-disabled">Coming Soon</span>
          </article>
        </div>
      </div>
    </section>

    <!-- Monthly Deck Generation -->
    <section class="section" aria-labelledby="deck-gen-title" data-auth-role="partner">
      <div class="container">
        <h2 id="deck-gen-title" style="font-size:1.4rem;margin-bottom:8px;">Monthly Deck</h2>
        <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:20px;">Generate board presentation decks from revenue data</p>

        <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap;">
          <label style="font-size:0.85rem;font-weight:500;">
            Month: <input type="month" id="rpt-deck-month" style="padding:6px 10px;border:1px solid var(--border-color);border-radius:4px;background:var(--bg-card);color:var(--text-primary);font-size:0.85rem;">
          </label>
          <button class="btn btn-primary" onclick="rptGenerateDeck()" style="font-size:0.85rem;padding:8px 16px;">Generate Deck</button>
          <button class="btn btn-secondary" onclick="rptRefreshMetrics()" style="font-size:0.85rem;padding:8px 16px;">Refresh Metrics</button>
        </div>

        <div id="rpt-deck-banner" style="padding:12px 16px;border-radius:8px;margin-bottom:16px;font-size:0.85rem;display:none;"></div>

        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;font-size:0.85rem;">
            <thead>
              <tr style="border-bottom:1px solid var(--border-color);">
                <th style="text-align:left;padding:8px 12px;font-weight:600;">Month</th>
                <th style="text-align:right;padding:8px 12px;font-weight:600;">Revenue (IDR)</th>
                <th style="text-align:right;padding:8px 12px;font-weight:600;">Gross Margin</th>
                <th style="text-align:left;padding:8px 12px;font-weight:600;">Headline</th>
                <th style="text-align:left;padding:8px 12px;font-weight:600;">Actions</th>
              </tr>
            </thead>
            <tbody id="rpt-deck-tbody">
              <tr><td colspan="5" style="text-align:center;padding:32px;color:var(--text-secondary);">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p class="footer-content">&copy; 2026 Candidlabs - Internal Use Only</p>
    </div>
  </footer>

  <script src="auth.js"></script>
  <script src="data-adapter.js"></script>
  <script src="script.js"></script>
  <script>
    var RPT_API = 'https://candidlabs-api.dieterwerwath.workers.dev/api';

    function rptFormatIDR(num) {
      if (num == null || isNaN(num)) return '-';
      if (num >= 1e9) return 'IDR ' + (num / 1e9).toFixed(1) + 'B';
      if (num >= 1e6) return 'IDR ' + (num / 1e6).toFixed(1) + 'M';
      if (num >= 1e3) return 'IDR ' + (num / 1e3).toFixed(0) + 'K';
      return 'IDR ' + num.toLocaleString();
    }

    function rptEscape(s) { if (!s) return ''; var d = document.createElement('div'); d.appendChild(document.createTextNode(s)); return d.innerHTML; }

    function rptLoadDeckMetrics() {
      if (typeof CandidStore === 'undefined') return;
      CandidStore.load('deck_metrics').then(function (data) {
        var deck = (data || []).slice().sort(function (a, b) { return (b.month_key || '').localeCompare(a.month_key || ''); });
        var tbody = document.getElementById('rpt-deck-tbody');
        if (!deck.length) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:32px;color:var(--text-secondary);">No deck metrics yet</td></tr>';
          return;
        }
        tbody.innerHTML = deck.map(function (d) {
          var meta = {}; try { meta = JSON.parse(d.meta || '{}'); } catch (e) {}
          var presLink = meta.presentation_url
            ? '<a href="' + rptEscape(meta.presentation_url) + '" target="_blank" rel="noopener" style="color:var(--color-primary);font-weight:500;">View Deck</a>'
            : '';
          return '<tr style="border-bottom:1px solid var(--border-color);">' +
            '<td style="padding:8px 12px;font-weight:500;">' + rptEscape(d.month_label || d.month_key) + '</td>' +
            '<td style="padding:8px 12px;text-align:right;font-family:monospace;">' + rptFormatIDR(d.total_revenue_idr) + '</td>' +
            '<td style="padding:8px 12px;text-align:right;">' + (d.gross_margin_pct != null ? d.gross_margin_pct + '%' : '-') + '</td>' +
            '<td style="padding:8px 12px;color:var(--text-secondary);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + rptEscape(d.headline || '-') + '</td>' +
            '<td style="padding:8px 12px;">' + presLink +
              (presLink ? ' ' : '') +
              '<button onclick="rptGenerateDeck(\'' + rptEscape(d.month_key) + '\')" style="font-size:0.78rem;padding:3px 8px;border:1px solid var(--border-color);border-radius:4px;background:var(--bg-card);color:var(--text-primary);cursor:pointer;">Generate</button>' +
            '</td></tr>';
        }).join('');
      });
    }

    function rptGenerateDeck(monthKey) {
      if (!monthKey) monthKey = document.getElementById('rpt-deck-month').value;
      if (!monthKey) { alert('Select a month first.'); return; }
      if (!confirm('Generate slides deck for ' + monthKey + '?')) return;

      var banner = document.getElementById('rpt-deck-banner');
      banner.style.display = 'block';
      banner.style.background = 'rgba(59,130,246,0.08)';
      banner.style.border = '1px solid rgba(59,130,246,0.2)';
      banner.style.color = '#3b82f6';
      banner.textContent = 'Generating deck for ' + monthKey + '...';

      fetch(RPT_API + '/reports/deck/' + encodeURIComponent(monthKey) + '/generate', { method: 'POST' })
        .then(function (res) { return res.json(); })
        .then(function (body) {
          if (body.ok && body.result && body.result.presentation_url) {
            banner.style.background = 'rgba(16,185,129,0.08)';
            banner.style.border = '1px solid rgba(16,185,129,0.2)';
            banner.style.color = 'var(--color-success)';
            banner.innerHTML = 'Deck generated! <a href="' + rptEscape(body.result.presentation_url) + '" target="_blank" rel="noopener" style="color:inherit;font-weight:600;">Open Deck</a>';
            rptLoadDeckMetrics();
          } else {
            banner.style.background = 'rgba(239,68,68,0.08)';
            banner.style.border = '1px solid rgba(239,68,68,0.2)';
            banner.style.color = 'var(--color-error)';
            banner.textContent = 'Failed: ' + (body.error ? body.error.message : 'Unknown error');
          }
        }).catch(function (err) {
          banner.style.background = 'rgba(239,68,68,0.08)';
          banner.style.border = '1px solid rgba(239,68,68,0.2)';
          banner.style.color = 'var(--color-error)';
          banner.textContent = 'Error: ' + err.message;
        });
    }

    function rptRefreshMetrics() {
      var monthKey = document.getElementById('rpt-deck-month').value || new Date().toISOString().slice(0, 7);
      if (!confirm('Refresh deck metrics for ' + monthKey + '?')) return;

      fetch(RPT_API + '/sales/refresh-deck-metrics', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ month_key: monthKey })
      }).then(function (res) { return res.json(); })
        .then(function (body) {
          if (body.ok) {
            alert('Metrics refreshed for ' + monthKey);
            rptLoadDeckMetrics();
          } else {
            alert('Failed: ' + (body.error ? body.error.message : 'Unknown'));
          }
        }).catch(function (err) { alert('Error: ' + err.message); });
    }

    document.addEventListener('DOMContentLoaded', function () {
      // Default month picker to current month
      var monthInput = document.getElementById('rpt-deck-month');
      if (monthInput) monthInput.value = new Date().toISOString().slice(0, 7);
      rptLoadDeckMetrics();
    });
  </script>
</body>
</html>
